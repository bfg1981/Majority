<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Majority Calculator â€“ Governing Body Demo</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <h1>Governing body viewer</h1>
  <p>This demo loads a governing-body JSON and shows each group as a selectable item.</p>

  <select id="governing-body-id"></select>
  <select id="governing-body-period"></select>

  <div id="governing-body-output"></div>

  <script src="governing-body-viewer.js"></script>

  <!-- INTEGRATED MANIFEST + DROPDOWN + LOADER LOGIC -->
  <script type="module">
    import { getManifestSlow, createManifest } from "./getManifest.js";

    const idSelect = document.getElementById("governing-body-id");
    const periodSelect = document.getElementById("governing-body-period");
    const outputId = "governing-body-output";

    const domReady = new Promise((resolve) => {
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", resolve, { once: true });
      } else {
        resolve();
      }
    });

    const manifestReady = new Promise((resolve) => {
      getManifestSlow((configs) => {
        const manifest = createManifest(configs);
        resolve(manifest);
      });
    });

    Promise.all([domReady, manifestReady]).then(([, manifest]) => {
      const ids = Object.keys(manifest);
      if (ids.length === 0) return;

      // Populate ID dropdown
      idSelect.innerHTML = "";
      for (const id of ids) {
        const opt = document.createElement("option");
        opt.value = id;
        opt.textContent = id;
        idSelect.appendChild(opt);
      }

      let currentId = ids[0];
      let currentPeriod = null;

      function populatePeriods(preservePeriod = true) {
        const periods = Object.keys(manifest[currentId] || {});
        periodSelect.innerHTML = "";

        for (const p of periods) {
          const opt = document.createElement("option");
          opt.value = p;
          opt.textContent = p;
          periodSelect.appendChild(opt);
        }

        if (preservePeriod && currentPeriod && periods.includes(currentPeriod)) {
          periodSelect.value = currentPeriod;
        } else {
          currentPeriod = periods[0] || null;
          periodSelect.value = currentPeriod;
        }
      }

      function loadCurrent() {
        if (!currentId || !currentPeriod) return;
        const file = manifest[currentId][currentPeriod];
        if (file) {
          loadGoverningBody(file, outputId);
        }
      }

      // Initial population + load
      populatePeriods(false);
      loadCurrent();

      idSelect.addEventListener("change", () => {
        const previousPeriod = currentPeriod;
        currentId = idSelect.value;
        currentPeriod = previousPeriod;
        populatePeriods(true);
        loadCurrent();
      });

      periodSelect.addEventListener("change", () => {
        currentPeriod = periodSelect.value;
        loadCurrent();
      });
    });
  </script>

</body>
</html>
